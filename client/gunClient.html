<html>
<head>
    <meta charset="UTF-8">
    <title>GunDB Scripture Proof of Concept</title>
</head>
<body>
<h1>GunDB Scripture Proof of Concept</h1>

<ul id="collectionList">

</ul>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
<script>
    var gun = Gun('http://localhost:2468/gun');
    var gunCollections = gun.get('unfoldingWord').get('collections');
    var localData = {};

    gunCollections.map().on(function (node, nodeID) {
        console.log(`${nodeID} was updated! Updating local data...`);
        let tokenCount = 0;
        gunCollections.get(nodeID).get("tokenIds").map().once(function (foo, baa) {tokenCount++});
        localData[nodeID] = tokenCount;
        renderList(localData);
    });

    function renderList(collections) {
        console.log('re-rendering UI...');
        var collectionList = document.getElementById("collectionList");
        collectionList.innerHTML = '';
        for (let [nodeID, count] of Object.entries(collections)) {
            if (count !== null) {
                console.log('rendering this object');
                const text = document.createElement('div');
                text.innerHTML = `<b>${nodeID}</b>: ${count} tokens`;
                const item = document.createElement('li');
                item.id = nodeID;
                item.appendChild(text);
                collectionList.appendChild(item);
            }
        }
    }

</script>
</body>
</html>